IMAGE=${PWD}/image

cp: hack
	cp exploit ./share/hack && cp hello ./share/hello

hack: exploit.c hello.c
	$(CC) -o exploit exploit.c -lpthread -static && \
		$(CC) -o hello hello.c -static -g `pkg-config fuse --cflags --libs`

run:
	qemu-system-x86_64 \
		-m 2G \
		-smp 2 \
		-kernel ${PWD}/bzImage \
		-append "console=ttyS0 root=/dev/sda earlyprintk=serial net.ifnames=0" \
		-drive file=${IMAGE}/bullseye.img,format=raw \
		-net user,host=10.0.2.10,hostfwd=tcp:127.0.0.1:10021-:22 \
		-net nic,model=e1000 \
		-virtfs local,path=./share/,mount_tag=host0,security_model=passthrough,id=host0 \
		-enable-kvm \
		-nographic \
		-pidfile vm.pid \
		2>&1 | tee vm.log
	
dbg:
	qemu-system-x86_64 \
		-m 2G \
		-smp 2 \
		-kernel ${PWD}/bzImage \
		-append "console=ttyS0 root=/dev/sda earlyprintk=serial net.ifnames=0" \
		-drive file=${IMAGE}/bullseye.img,format=raw \
		-net user,host=10.0.2.10,hostfwd=tcp:127.0.0.1:10021-:22 \
		-net nic,model=e1000 \
		-virtfs local,path=./share/,mount_tag=host0,security_model=passthrough,id=host0 \
		-nographic \
		-pidfile vm.pid \
		-s \
		2>&1 | tee vm.log

gdb:
	sudo gdb -ex "target remote :1234" -ex "ksymaddr-remote-apply" -ex "b sys_kcmp" -ex "c"

connect:
	ssh -i $(IMAGE)/bullseye.id_rsa -p 10021 -o "StrictHostKeyChecking no" root@localhost

clean: hack 
	rm exploit

kill: vm.pid
	kill `cat vm.pid`