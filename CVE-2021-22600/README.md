# CVE-2021-22600


Wrote this exploit to try out the [`USMA: Share kernel code with me`](https://i.blackhat.com/Asia-22/Thursday-Materials/AS-22-YongLiu-USMA-Share-Kernel-Code-wp.pdf) technique. Tested on the provided kernel image ([bzImage](./bzImage)). To be tested on a real target.

### Setup:
```bash
sudo apt install libfuse-dev libfuse2

cd ./image &&
    chmod +x ./create-image.sh && \
    ./create-image.sh -f minimal && \
    cd ..

mkdir share
make cp && make run
```
<sub>Default user is `root`, add a new user and run the exploit. Run `mkdir /tmp/share; mount -t 9p -o trans=virtio,version=9p2000.L host0 /tmp/share` inside vm for host-guest file sharing. And make sure to install fuse in the vm `apt install fuse`</sub>


Config options I've turned on along with default linux kernel config:
```
CONFIG_FUSE_FS=y
CONFIG_NET_NS=y
CONFIG_USER_NS=y
```

<sub>* SELinux turned off for other purpose but that shouldn't matter I guess</sub>

### References

- [https://chompie.rip/Blog+Posts/Put+an+io_uring+on+it+-+Exploiting+the+Linux+Kernel](https://chompie.rip/Blog+Posts/Put+an+io_uring+on+it+-+Exploiting+the+Linux+Kernel)
- [USMAï¼šShare Kernel Code with Me](https://i.blackhat.com/Asia-22/Thursday-Materials/AS-22-YongLiu-USMA-Share-Kernel-Code-wp.pdf) [[slides]](https://i.blackhat.com/Asia-22/Thursday-Materials/AS-22-YongLiu-USMA-Share-Kernel-Code.pdf) [[Video]](https://youtu.be/JpPWp-LjmZU)
- [https://elixir.bootlin.com/linux/v4.14.190/source/net/packet/af_packet.c](https://elixir.bootlin.com/linux/v4.14.190/source/net/packet/af_packet.c)
- [https://www.kernel.org/doc/Documentation/networking/packet_mmap.txt](https://www.kernel.org/doc/Documentation/networking/packet_mmap.txt)
- [Got idea for using pipe_buffer for leak from r4j's exploit https://github.com/r4j0x00/exploits/blob/master/CVE-2021-22600/exploit.c](https://github.com/r4j0x00/exploits/blob/master/CVE-2021-22600/exploit.c)